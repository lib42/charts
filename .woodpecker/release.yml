---
steps:
  helm-repo:
    image: quay.io/helmpack/chart-releaser@sha256:4ba13e667228d4a2b7a409e3787ca8b4413ff6e8b1306784d240c954f26bec2e
    commands:
    - git config --global user.email "noreply@lib42.github.io"
    - git config --global user.name "Woodpecker-CI"
    - git fetch --all -v
    - mkdir -p ~/.config/helm
    - cp .helmrepos.yaml ~/.config/helm/repositories.yaml

    - cr package charts/*
    - cr upload --owner lib42 --git-repo charts --token $${GH_TOKEN} --skip-existing --pages-branch repo --package-path .cr-release-packages

    - git checkout origin/repo

    - cr index --owner lib42 --git-repo charts --token $${GH_TOKEN} --pages-branch repo --package-path .cr-release-packages --index-path index.yaml --push
    when:
      - event: push
        branch: main
        path:
        - charts/**
        - .woodpecker/release.yml
      - event: [ "manual", "cron" ]
    environment: 
      GH_TOKEN:
        from_secret: "gh_token"
